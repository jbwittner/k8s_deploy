apiVersion: v1
kind: ConfigMap
metadata:
  name: minecraft-backup-script
  namespace: minecraft
data:
  backup-script.sh: |
    #!/bin/bash

    # Script de sauvegarde avancÃ© pour les serveurs Minecraft
    # Ã€ exÃ©cuter depuis l'intÃ©rieur du pod admin

    BACKUP_DIR="/backups"
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    DATE_FOLDER=$(date +%Y-%m)

    # CrÃ©er le dossier du mois si nÃ©cessaire
    mkdir -p "$BACKUP_DIR/$DATE_FOLDER"

    echo "ğŸ® DÃ©marrage de la sauvegarde Minecraft - $TIMESTAMP"
    echo "ğŸ“ Dossier de destination: $BACKUP_DIR/$DATE_FOLDER"

    # Fonction de sauvegarde avec compression et vÃ©rification
    backup_server() {
        local server_name=$1
        local source_path=$2
        local backup_file="$BACKUP_DIR/$DATE_FOLDER/minecraft-${server_name}-${TIMESTAMP}.zip"
        
        echo "ğŸ’¾ Sauvegarde du serveur $server_name..."
        
        # VÃ©rifier que le dossier source existe
        if [ ! -d "$source_path" ]; then
            echo "âŒ Erreur: Le dossier $source_path n'existe pas!"
            return 1
        fi
        
        # CrÃ©er l'archive
        if zip -r "$backup_file" "$source_path" > /dev/null 2>&1; then
            # VÃ©rifier la taille et l'intÃ©gritÃ©
            local file_size=$(du -h "$backup_file" | cut -f1)
            echo "âœ… $server_name sauvegardÃ© ($file_size) -> $(basename "$backup_file")"
            
            # Test d'intÃ©gritÃ© de l'archive
            if unzip -t "$backup_file" > /dev/null 2>&1; then
                echo "ğŸ” Archive $server_name vÃ©rifiÃ©e avec succÃ¨s"
            else
                echo "âš ï¸  Attention: L'archive $server_name pourrait Ãªtre corrompue"
            fi
        else
            echo "âŒ Erreur lors de la sauvegarde de $server_name"
            return 1
        fi
    }

    # Sauvegarder les serveurs
    backup_server "ppz" "/minecraft-data/ppz"
    backup_server "nohu" "/minecraft-data/nohu"

    # RÃ©sumÃ© des sauvegardes
    echo ""
    echo "ğŸ“Š RÃ©sumÃ© des sauvegardes crÃ©Ã©es:"
    ls -lh "$BACKUP_DIR/$DATE_FOLDER/minecraft-*-${TIMESTAMP}.zip" 2>/dev/null || echo "Aucune sauvegarde trouvÃ©e"

    # Nettoyage automatique des anciennes sauvegardes (garde les 30 derniers jours)
    echo ""
    echo "ğŸ§¹ Nettoyage des anciennes sauvegardes (>30 jours)..."
    find "$BACKUP_DIR" -name "minecraft-*.zip" -type f -mtime +30 -delete
    deleted_count=$(find "$BACKUP_DIR" -name "minecraft-*.zip" -type f -mtime +30 | wc -l)
    echo "ğŸ—‘ï¸  $deleted_count ancienne(s) sauvegarde(s) supprimÃ©e(s)"

    # Afficher l'espace disque utilisÃ©
    echo ""
    echo "ğŸ’½ Utilisation de l'espace de sauvegarde:"
    du -sh "$BACKUP_DIR"

    echo ""
    echo "âœ… Sauvegarde terminÃ©e - $TIMESTAMP"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: minecraft-init-script
  namespace: minecraft
data:
  init-script.sh: |
    #!/bin/bash
    
    echo "ğŸš€ Initialisation du pod admin Minecraft..."
    
    # Mise Ã  jour des paquets
    echo "ğŸ“¦ Mise Ã  jour des paquets..."
    apt-get update -qq
    
    # Installation des outils essentiels
    echo "ğŸ› ï¸ Installation des outils..."
    apt-get install -y -qq \
        nano vim rsync zip unzip curl wget git \
        openssh-server htop tree ncdu
    
    # Configuration SSH
    echo "ğŸ” Configuration SSH..."
    mkdir -p /var/run/sshd
    echo 'root:minecraft123' | chpasswd
    
    # Configuration SSH sÃ©curisÃ©e
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
    sed -i 's/UsePAM yes/UsePAM no/' /etc/ssh/sshd_config
    
    # DÃ©marrage SSH en arriÃ¨re-plan
    echo "ğŸ”‘ DÃ©marrage du service SSH..."
    /usr/sbin/sshd -D &
    
    # Configuration des alias
    echo "âš™ï¸ Configuration des alias..."
    cat >> /root/.bashrc << 'EOFBASH'
    alias ll='ls -la'
    alias ppz='cd /minecraft-data/ppz'
    alias nohu='cd /minecraft-data/nohu'
    alias backup='cd /backups'
    alias minecraft-backup='/backup-script.sh'
    EOFBASH
    
    # Permissions des scripts
    chmod +x /backup-script.sh 2>/dev/null || true
    
    # CrÃ©ation des dossiers de base
    mkdir -p /minecraft-data/ppz /minecraft-data/nohu /backups
    
    echo "âœ… Initialisation terminÃ©e!"
    echo "ğŸ® Pod admin Minecraft prÃªt Ã  l'utilisation"
    echo "ğŸ”— Connexion SSH: port 22 (mot de passe: minecraft123)"
